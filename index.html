<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Puzzle Builder & Merge Game</title>
<style>
body { font-family: Arial; background: #f4f6f8; padding: 20px; }
h1, h2 { text-align: center; }
.section { max-width: 1100px; margin: auto; background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
.category { border: 2px solid #ddd; padding: 12px; margin-bottom: 15px; border-radius: 6px; }
input[type="text"], select { width: 250px; margin-bottom: 5px; }
button { padding: 6px 10px; cursor: pointer; margin: 4px 0; }
#grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 6px; margin-top: 20px; position: relative; }
.tile { padding: 10px; border-radius: 6px; cursor: pointer; transition: 0.3s; text-align: center; word-wrap: break-word; background: lightgray; }
.tile.selected { outline: 3px solid black; }
.tile.collapsing { transform: scale(0.3); opacity: 0; transition: 0.3s; }
.tile.shake { animation: shake 0.4s; }
.group-label { font-weight: bold; border-bottom: 2px solid rgba(0,0,0,0.2); margin-bottom: 4px; }

/* Red X overlay */
#redX {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%) scale(0);
    font-size: 100px;
    color: red;
    pointer-events: none;
    opacity: 0;
    transition: transform 0.3s ease, opacity 0.3s ease;
}
#redX.show {
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
}

/* Shake animation */
@keyframes shake {
  0% { transform: translateX(0); }
  25% { transform: translateX(-8px); }
  50% { transform: translateX(8px); }
  75% { transform: translateX(-8px); }
  100% { transform: translateX(0); }
}

/* Stats */
#stats { text-align:center; margin-top: 10px; font-size: 16px; }
</style>
</head>
<body>

<h1>Puzzle Builder</h1>

<div class="section" id="builder">
    <h2>Create Categories</h2>
    <div style="text-align:center; margin-bottom:10px;">
        <button id="addCategoryBtn">+ Add Category</button>
        <button id="generateBtn">Generate Game Link</button>
    </div>
    <div id="categories"></div>
    <p id="linkOutput"></p>
</div>

<div class="section" id="game" style="display:none;">
    <h2>Play Puzzle</h2>
    <div id="grid">
        <div id="redX">âœ–</div>
    </div>
    <div id="stats">
        Mistakes: <span id="mistakes">0</span> | Time: <span id="timer">0:00</span>
    </div>
    <p id="message"></p>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {

const builder = document.getElementById("builder");
const gameSection = document.getElementById("game");
const categoriesDiv = document.getElementById("categories");
const addCategoryBtn = document.getElementById("addCategoryBtn");
const generateBtn = document.getElementById("generateBtn");
const linkOutput = document.getElementById("linkOutput");
const redX = document.getElementById("redX");
const mistakesSpan = document.getElementById("mistakes");
const timerSpan = document.getElementById("timer");
const colors = ["red","blue","green","yellow","orange","purple","pink","brown","gray","teal"];

let categoryCount = 0;
let mistakes = 0;
let timerInterval;
let secondsElapsed = 0;

// ---------------- Add Category ----------------
function addCategory() {
    if(categoryCount >=10){ alert("You can only add up to 10 categories."); return; }
    const categoryDiv = document.createElement("div");
    categoryDiv.className="category";

    const title=document.createElement("input");
    title.type="text"; title.placeholder="Category Title"; categoryDiv.appendChild(title); categoryDiv.appendChild(document.createElement("br"));

    const colorLabel=document.createElement("div"); colorLabel.textContent="Category Color:"; categoryDiv.appendChild(colorLabel);

    const colorSelect=document.createElement("select");
    colors.forEach(c=>{const opt=document.createElement("option"); opt.value=c; opt.textContent=c; colorSelect.appendChild(opt);});
    categoryDiv.appendChild(colorSelect); categoryDiv.appendChild(document.createElement("br"));

    const removeBtn=document.createElement("button"); removeBtn.textContent="Remove Category";
    removeBtn.addEventListener("click",()=>{ categoriesDiv.removeChild(categoryDiv); categoryCount--; toggleAddCategoryBtn(); });
    categoryDiv.appendChild(removeBtn); categoryDiv.appendChild(document.createElement("br")); categoryDiv.appendChild(document.createElement("br"));

    for(let i=1;i<=10;i++){
        const input=document.createElement("input");
        input.type="text"; input.placeholder="Answer "+i; categoryDiv.appendChild(input); categoryDiv.appendChild(document.createElement("br"));
    }

    categoriesDiv.appendChild(categoryDiv);
    categoryCount++; toggleAddCategoryBtn();
}
function toggleAddCategoryBtn(){ addCategoryBtn.disabled = categoryCount>=10; }
addCategoryBtn.addEventListener("click",addCategory);

// ---------------- Generate Link ----------------
generateBtn.addEventListener("click",function(){
    const categoryEls=categoriesDiv.querySelectorAll(".category");
    let groups=[]; let totalWords=0;
    for(const cat of categoryEls){
        const inputs=cat.querySelectorAll("input[type=text]");
        const title=inputs[0].value.trim();
        const words=Array.from(inputs).slice(1).map(i=>i.value.trim()).filter(Boolean);
        const color=cat.querySelector("select").value;
        totalWords += words.length;
        if(!title||words.length!==10){ alert("Each category must have a title and exactly 10 words."); return; }
        groups.push({name:title,color,words});
    }
    const requiredWords=categoryCount*10;
    if(totalWords!==requiredWords){ alert(`You must have exactly ${requiredWords} words in total. Currently: ${totalWords}`); return; }

    let encoded=btoa(JSON.stringify(groups)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
    const link=location.origin+location.pathname+"#puzzle="+encoded;
    linkOutput.innerHTML=`<strong>Share this link:</strong><br><a href="${link}" target="_blank">${link}</a>`;
});

// ---------------- Merge Game ----------------
let tiles=[];
let selected=[];
const grid=document.getElementById("grid");
const message=document.getElementById("message");

// ---------------- Timer ----------------
function startTimer(){
    secondsElapsed=0;
    timerSpan.textContent="0:00";
    clearInterval(timerInterval);
    timerInterval = setInterval(()=>{
        secondsElapsed++;
        const mins=Math.floor(secondsElapsed/60);
        const secs=secondsElapsed%60;
        timerSpan.textContent=`${mins}:${secs.toString().padStart(2,'0')}`;
    },1000);
}

function startGame(groups){
    tiles=[];
    groups.forEach(g=>{
        g.words.forEach(w=>{
            tiles.push({label:w, group:g.name, color:g.color, size:1, merged:false});
        });
    });
    tiles.sort(()=>Math.random()-0.5);
    selected=[];
    mistakes=0;
    mistakesSpan.textContent = mistakes;
    startTimer();
    render();
}

function render(){
    grid.querySelectorAll(".tile:not(#redX)").forEach(t=>t.remove());
    tiles.forEach((t,i)=>{
        const div=document.createElement("div");
        div.className="tile";
        div.style.background=t.merged?t.color:"lightgray";
        if(selected.includes(i)) div.classList.add("selected");
        div.innerHTML=t.label;
        div.onclick=()=>toggle(i);
        grid.appendChild(div);
    });
}

// ---------------- Red X + Shake ----------------
function showRedX(){
    redX.classList.add("show");
    selected.forEach(i=>{
        const tileEl = grid.querySelectorAll(".tile:not(#redX)")[i];
        tileEl.classList.add("shake");
        setTimeout(()=>tileEl.classList.remove("shake"),400);
    });
    setTimeout(()=>redX.classList.remove("show"),600);
}

// ---------------- Tile Selection ----------------
function toggle(i){
    if(selected.includes(i)){ selected=selected.filter(x=>x!==i); render(); return; }
    if(selected.length>=2){ return; } // Only 2 tiles
    selected.push(i); render();
    if(selected.length===2) checkPair();
}

// ---------------- Check Pair & Merge ----------------
function checkPair(){
    const a=tiles[selected[0]]; const b=tiles[selected[1]];

    if(a.group!==b.group){
        // Incorrect: show red X, shake, update mistakes
        mistakes++;
        mistakesSpan.textContent = mistakes;
        showRedX();
        selected=[];
        render();
        return;
    }

    const groupName=a.group;
    const groupSize=10;
    const newSize=a.size+b.size;
    const isFinalMerge=newSize===groupSize;

    const els=[...grid.querySelectorAll(".tile:not(#redX)")];
    selected.forEach(i=>els[i].classList.add("collapsing"));

    setTimeout(()=>{
        const mergedLabel = isFinalMerge ? `<div class="group-label">${groupName}</div>${a.label}<br>${b.label}` : a.label+"<br>"+b.label;
        selected.sort((x,y)=>y-x).forEach(i=>tiles.splice(i,1));
        tiles.push({label:mergedLabel, group:groupName, color:a.color, size:newSize, merged:isFinalMerge});
        selected=[];
        render();
        if(tiles.every(t=>t.merged)){
            message.textContent="FUCKING NERD!";
            clearInterval(timerInterval);
        }
    },300);
}

// ---------------- Puzzle Hash Handling ----------------
function loadPuzzleFromHash(){
    const hash=location.hash;
    if(hash.startsWith("#puzzle=")){
        try{
            let encoded=hash.replace("#puzzle=","").replace(/-/g,"+").replace(/_/g,"/");
            while(encoded.length%4) encoded+="=";
            const groups=JSON.parse(atob(encoded));
            builder.style.display="none"; gameSection.style.display="block"; startGame(groups);
        }catch(err){ console.error("Failed to load puzzle:",err); alert("Invalid puzzle link!"); }
    }
}
loadPuzzleFromHash();
window.addEventListener("hashchange",loadPuzzleFromHash);
addCategory(); // first category

});
</script>
</body>
</html>
